name: Python CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort ruff mypy
    
    - name: Run black
      run: black --check --diff models/ training/ utils/ tests/
    
    - name: Run isort
      run: isort --check-only --diff models/ training/ utils/ tests/
    
    - name: Run ruff
      run: ruff check models/ training/ utils/ tests/
    
    - name: Run mypy (infrastructure only)
      run: mypy --strict utils/ --ignore-missing-imports || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libhdf5-dev libnetcdf-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install pytest pytest-cov pytest-xdist
        pip install -r requirements.txt || true
    
    - name: Run unit tests
      run: |
        pytest tests/ -v --cov=models --cov=training --cov=utils \
          --cov-report=xml --cov-report=term-missing \
          -n auto --maxfail=5
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt || true
    
    - name: Run smoke test
      run: |
        python -c "
        import torch
        import sys
        
        # Test imports
        try:
            from models.enhanced_datacube_unet import EnhancedCubeUNet
            from models.rebuilt_llm_integration import RebuiltLLMIntegration
            from models.rebuilt_graph_vae import RebuiltGraphVAE
            print('✅ Core model imports successful')
        except Exception as e:
            print(f'❌ Import error: {e}')
            sys.exit(1)
        
        # Test model initialization
        try:
            model = EnhancedCubeUNet(n_input_vars=5, n_output_vars=5)
            print(f'✅ Model initialized: {sum(p.numel() for p in model.parameters())} parameters')
        except Exception as e:
            print(f'❌ Model initialization error: {e}')
            sys.exit(1)
        
        # Test forward pass
        try:
            x = torch.randn(2, 5, 8, 16, 16, 8)
            y = model(x)
            print(f'✅ Forward pass successful: {y.shape}')
        except Exception as e:
            print(f'❌ Forward pass error: {e}')
            sys.exit(1)
        
        print('✅ Smoke test passed!')
        "

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material mkdocstrings[python]
    
    - name: Build documentation
      run: |
        mkdocs build --strict || echo "Documentation build failed (non-blocking)"
    
    - name: Upload documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: site/

